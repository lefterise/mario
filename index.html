<!DOCTYPE html>”
<html>
<head>
<style>
html, body {
  margin: 0;
}
</style>

<script>
var level1 = [
"                                                                         üüüüü                                                  @@@@23@@@@       á                                  ",
"                                                       á             â         ã                                                  @@23@@         $       ***                        ",
"                                           *           $  M      J? J?         $$                                                   23                  @ € @                       ",
"     M            M                        *              o M                        @ ‰ @      M     ****                  M       01        M         @@@@@      M        M       ",
"     o M        M o            M     JJJJJ *             Mo o               M        @@@@@      o                           oM      èá        o                    o   M    o M     ",
"    Mo o  à     o o            o           *       à     oo o               o            @‰  @  o  …             …          oo           …    o        *******    Mo   o   Mo o     ",
"    oo o ??     o o            o           *     01?     oo o   ?J ?J       o            @@@@@  o                   í   à   oo ****           o       @     € @   oo   o   oo o     ",
"    oo o        o o       01   o  JJ       *     23      oo o               o   @  ‰@           o  01 $$$$$01   K01 ? JJJ   oo           01   o       @@@@@@@@@   oo   E   oo o 01  ",
"    oo o     01 o o  **   23   o               0123      oo o               o   @@@@@        à  o  23      23    23         oo           23   o                   oo   o   oo o 23  ",
"    oo o     23 o o       23   o               2323      oo o               o                $  o  23 €    23    23         oo           23   o                   oo   o   ooˆo 23  ",
"w   oo oww   23 o o   €ww 23   owww€€        ˆ 2323 ww   oo o ˆ    €   €    o                 wwo  23 ww € 23 wwˆ23  ww I   oo  wwˆ  ˆww 23 wwo      www          oww ˆo   wwwo 23ww",
"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFWFFFFFWWWWWWWWWWWWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFWWFFFFFFFFFFFFFFFFFFFFFWWWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFWFFFFFWWWWWWWWWWWWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFWWFFFFFFFFFFFFFFFFFFFFFWWWWWFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
];

class Graphics{
  constructor(ctx){
	 this.ctx = ctx;
	 this.loadImage("mario.png",   (img)=>{this.mario = img;});
	 this.loadImage("enemies.png", (img)=>{this.enemies = img;});
	 this.loadImage("terrain.png", (img)=>{this.terrain = img;});
	 this.loadImage("tree.png",    (img)=>{this.tree = img;});
  }
  
  loadImage(file, callback){
	  let img = new Image();
	  img.src = file;
	  img.onload = ()=>{callback(img);};
  }

  drawMario(x, y, frame, size, direction){
     this.ctx.drawImage(this.mario, frame * 60 + direction * 180, size * 81, 60, 81, x, y, 60, 81); 
  }
  
  drawTile(x,y,id){
	  this.ctx.drawImage(this.terrain, (id % 8) * 60, Math.floor(id / 8) * 42, 60, 42, x, y, 60, 42);
  }
  
  drawWater(x,y, frame){
      this.ctx.drawImage(this.terrain, (13 % 8) * 60, Math.floor(13 / 8) * 42 + frame, 60, 42 - frame, x, y, 60, 42 - frame);
	  this.ctx.drawImage(this.terrain, (13 % 8) * 60, Math.floor(13 / 8) * 42, 60, frame, x, y + 42  - frame, 60, frame);
  }
  
  drawTree(x,y, frame){
	  this.ctx.drawImage(this.tree, 0,3 +70 * (frame % 2), 164, 70, x-51, y-42, 164, 70);
  }
  
  drawWeed(x,y, frame){
	  this.ctx.drawImage(this.tree, 0,145 + 42 * (frame % 2), 120, 43, x, y-16, 120, 43);
  }
  
  drawCoin(x,y, frame){    
	this.ctx.drawImage(this.enemies, 42 * frame,564, 42, 39, x, y, 42, 39);
  }

  drawGoomba(x,y, frame){    
	this.ctx.drawImage(this.enemies, 63 * (frame % 2),0, 60, 45, x, y - 17, 60, 45);
  }
  
  drawTurtle(x,y, frame, color){    
	this.ctx.drawImage(this.enemies, 63 * (frame % 2), 92 + 145 * color, 60, 67, x, y - 41, 60, 67);
  }
  
  createBlueSkyGradient(){
	const grd = this.ctx.createLinearGradient(0, 0, 0, 546);
	grd.addColorStop(0,   "#48ACE8");
	grd.addColorStop(0.75,"#C0E8E8");
	grd.addColorStop(1,   "#C0E8E8");
	return grd;
  }
}

function getId(c, u, l, r, ul, ur){
if (c == "F"){
 if (u != "F"){
   if (l != "F") return 0;
   if (r != "F") return 4;
   return 1;
 }
 if (l != "F") return 5;
 if (r != "F") return 7;
 if (ul != "F") return 2;
 if (ur != "F") return 3;
 return 6;
 }
 if (c == "o") return 32;
 if (c == "W") return 13;
 if (c == "M") return 100; 
 if (c == "0") return 40;
 if (c == "1") return 41;
 if (c == "2") return 48;
 if (c == "3") return 49;
 if (c == "@") return 18;
 if (c == "E") return 33;
 if (c == "?") return 20;
 if (c == "J") return 17;
 if (c == "*") return 101;
 if (c == "w") return 102;
 if (c == "€") return 103;
 if (c == "ˆ") return 104;
 if (c == "‰") return 105;
 
 
 return 255;
}

function getTile(y,x){
	if (y >= 0 && x >=0 && y < level1.length && x < level1[y].length)
		return level1[y][x];
	return 255;
}

function parseLevel(){
	let level = new Array(level1[0].length);
	//this will convert the level walls to draw the grass and corners 
	//as well as filp from row major to column major so that data on a screen will be more compact;
	for (let x=0; x<level1[0].length;++x){
		level[x] = new Array(level1.length);
		for (let y=0; y<13;++y){	   
		   level[x][y] = getId(
		   getTile(y,x),
		   getTile(y-1,x),
		   getTile(y,x-1),
		   getTile(y,x+1),
		   getTile(y-1,x-1),
		   getTile(y-1,x+1));
	   }
   }
   return level;
}

class Animation{
  constructor(frames, transitionTime){
     this.frames = frames; 
     this.transitionTime = transitionTime;
	 this.frame = 0;
	 this.t = 0;
  }
  
  update(dt){
     this.t = this.t + dt;
     this.frame = (this.frame + Math.floor(this.t / this.transitionTime)) % this.frames;
	 this.t = this.t > this.transitionTime ? this.t - this.transitionTime : this.t;
  }
  
}

const Directions = {
	Idle: 0,
	Left: -1,
	Right: 1
}

class Keyboard{
	constructor(){
		this.direction = Directions.Idle;
	
		document.addEventListener('keydown', (ev) => {
			if (ev.key == "ArrowLeft" || ev.keyCode == 37){
				this.direction =  Directions.Left;
			}
			if (ev.key == "ArrowRight"|| ev.keyCode == 39){
				this.direction = Directions.Right;
			}
			
			if (ev.key == "Space" || ev.keyCode == 32){
				
			}
			
			ev.preventDefault();    
			return false;
		}, false);
		
		document.addEventListener('keyup', (ev) => {
			this.direction = Directions.Idle;
			ev.preventDefault();
			return false;
		}, false);
	}
	
	getDirection(){
		return this.direction;
	}
}

class Game{
	constructor(gfx, controls){
		this.gfx = gfx;
		this.controls = controls;
		this.frame = 0;
		this.treeAnimation = new Animation(2, 500);
		this.coinAnimation = new Animation(3, 333);
		
		this.screenX = 0;
		this.level = parseLevel();
		this.skyGradient = gfx.createBlueSkyGradient();
	}
	
	update(time){
	    let dt = time - (this.prevTime ?? time);
	    this.prevTime = time;
		this.treeAnimation.update(dt);
		this.coinAnimation.update(dt);
		
		this.frame = this.frame-2;
		if (this.frame <=0) this.frame = 41;
		//this.gfx.ctx.clearRect(0, 0, 1200, 546);
		
		this.gfx.ctx.fillStyle = this.skyGradient;
		this.gfx.ctx.fillRect(0, 0, 1200, 546);
				
		
		let direction = this.controls.getDirection();
		
		this.screenX = this.screenX + 8 * direction;
		let screenOffset = this.screenX % 60;
		let tileOffset = Math.floor(this.screenX / 60);
		
		for (let x=0; x<21;++x){
		    if (x+tileOffset < 0) continue;
			if (x+tileOffset >= this.level.length-1) break;
			for (let y=0; y<13;++y){
			   let tileId = this.level[x+tileOffset][y];
			   if (tileId != 255){				   				  
		           if (tileId == 101){
					  this.gfx.drawCoin(60 * x - screenOffset, 42 * y + 16, this.coinAnimation.frame);
				   }else if (tileId == 102){
					  this.gfx.drawWeed(60 * x - screenOffset, 42 * y + 16, this.treeAnimation.frame);
				   }else if (tileId == 103){
					  this.gfx.drawGoomba(60 * x - screenOffset, 42 * y + 16, this.treeAnimation.frame);
				   }else if (tileId == 104 || tileId == 105){
					  this.gfx.drawTurtle(60 * x - screenOffset, 42 * y + 16, this.treeAnimation.frame, tileId - 104);
				   }else if (tileId == 100){
					  this.gfx.drawTree(60 * x - screenOffset, 42 * y + 16, this.treeAnimation.frame);
				   }else if (tileId == 13){
					  this.gfx.drawWater(60 * x - screenOffset, 42*y+16, this.frame);
				   }else{
				     this.gfx.drawTile(60 * x - screenOffset, 42*y, tileId);
                   }				   
			   }
		   }
		}
		this.gfx.drawMario(400,381,0,2,0);
	}
}

function initGame(){
	var canvas = document.getElementById("MyCanvas");
	var ctx = canvas.getContext("2d");
	var graphics = new Graphics(ctx);
	var keyboard = new Keyboard();
	var game = new Game(graphics, keyboard);
	setInterval(()=>window.requestAnimationFrame((time)=>game.update(time)), 16);
}
</script>
</head>
<body onload="initGame()">
   <canvas id="MyCanvas" width="1200" height="546" style="border:1px solid #000000; background-color:#5080A0;"></canvas>
</body>
</html>